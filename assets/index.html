<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="stylesheet" href="/styles/main.css">
  <script src="/js/index.js"></script>
</head>
<body>
  <ul>
    <li>
      <a href="/tank2.html">坦克大战</a>
    </li>
    <li>
      <a href="/webgl.html">Webgl</a>
    </li>
  </ul>
  <div class="row-area">
    <div class="laugitid" contenteditable="true"></div>
    <button onclick="requestDataClick()">请求数据</button>
    <button onclick="notificationTest()">请求通知</button>
  </div>
  <div>
    <img style="width:200px;" src="/images/logo.png" />
  </div>
  <div>
    <button onclick="sendMsgBtnClick()">发送Message</button>
  </div>
  <div id="apiDataArea"></div>
  <script>
    const getDataApi = () => {
      return new Promise((res,rej) => {
        fetch('/crud-data-list.json')
          .then(response => response.json())
          .then(data => res(JSON.parse(data.data)))
          .catch(error => rej(error));
      })
    }
    const dataEle = document.getElementById('apiDataArea')
    async function requestDataClick(){
      dataEle.innerText = '';
      const apiData = await getDataApi();
      dataEle.innerText = JSON.stringify(apiData);
    }

    function sendMessageToSW(message) {
      // 方法1：如果已有 controller
      if (navigator.serviceWorker.controller) {
        navigator.serviceWorker.controller.postMessage(message);
        return;
      }
      
      // 方法2：等待 ready
      navigator.serviceWorker.ready.then(registration => {
        registration.active?.postMessage(message);
      }).catch(err => {
        console.error('发送消息失败:', err);
      });
      
      // 方法3：监听 controller 变化
      const handleControllerChange = () => {
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage(message);
          navigator.serviceWorker.removeEventListener(
            'controllerchange', 
            handleControllerChange
          );
        }
      };
      
      navigator.serviceWorker.addEventListener(
        'controllerchange', 
        handleControllerChange
      );
    }

    const sendMsgBtnClick = () => {
      sendMessageToSW({
        type:'INIT',
        payload:'Hello Service Worker'
      });
    }
  </script>
</body>
</html>
